<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexSense Data Manager (Simplified)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .device-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .device-actions {
            display: flex;
            gap: 5px;
        }
        .btn-action {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            color: #666;
        }
        .btn-rename:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .btn-delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .device-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        .sensor-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sensor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .sensor-info {
            flex: 1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sensor-name {
            font-weight: 500;
        }
        .file-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .no-devices {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .no-devices h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“¡ FlexSense Data Manager (Simplified)</h1>
        <p>HTTP-only sensor data collection - No MQTT required</p>
        <p>Ngrok: cougar-factual-osprey.ngrok-free.app</p>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3>{{ devices|length }}</h3>
            <p>Auto-Discovered Devices</p>
        </div>
        <div class="stat-card">
            <h3 id="total-sensors">0</h3>
            <p>Total Sensors</p>
        </div>
        <div class="stat-card">
            <h3 id="total-files">0</h3>
            <p>Data Files</p>
        </div>
    </div>

    {% if devices %}
        <div class="devices-grid">
            {% for device_id, sensors in devices.items() %}
            <div class="device-card">
                <div class="device-header">
                    <div class="device-name">{{ device_id }}</div>
                    <div class="device-actions">
                        <button class="btn-action btn-rename" onclick="renameDevice('{{ device_id }}')" title="Rename Device">Edit</button>
                        <button class="btn-action btn-delete" onclick="deleteDevice('{{ device_id }}')" title="Delete Device">Delete</button>
                    </div>
                </div>
                
                {% if sensors %}
                <ul class="sensor-list">
                    {% for sensor in sensors %}
                    <li class="sensor-item">
                        <span class="sensor-info" onclick="window.location.href='/device/{{ device_id }}/sensor/{{ sensor.name }}'">
                            <span class="sensor-name">{{ sensor.name }}</span>
                            <span class="file-count">{{ sensor.file_count }} files</span>
                        </span>
                        <button class="btn-action btn-delete" onclick="deleteSensor('{{ device_id }}', '{{ sensor.name }}')" title="Delete Sensor">Delete</button>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p style="color: #666; text-align: center;">No sensor data yet</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-devices">
            <h3>No devices found</h3>
            <p>Send data to the endpoints above and devices will appear automatically!</p>
        </div>
    {% endif %}

    <script>
        // Update total sensors and files count
        let totalSensors = 0;
        let totalFiles = 0;
        {% for device_id, sensors in devices.items() %}
            totalSensors += {{ sensors|length }};
            {% for sensor in sensors %}
                totalFiles += {{ sensor.file_count }};
            {% endfor %}
        {% endfor %}
        document.getElementById('total-sensors').textContent = totalSensors;
        document.getElementById('total-files').textContent = totalFiles;

        // Auto-refresh page every 60 seconds
        setTimeout(() => {
            window.location.reload();
        }, 60000);

        // Device management functions
        function deleteDevice(deviceId) {
            if (confirm(`Are you sure you want to delete device "${deviceId}" and all its data?`)) {
                fetch(`/api/device/${deviceId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => alert('Error deleting device: ' + error));
            }
        }

        function renameDevice(deviceId) {
            const newName = prompt(`Enter new name for device "${deviceId}":`, deviceId);
            if (newName && newName !== deviceId) {
                fetch(`/api/device/${deviceId}/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: newName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => alert('Error renaming device: ' + error));
            }
        }

        function deleteSensor(deviceId, sensorId) {
            if (confirm(`Are you sure you want to delete sensor "${sensorId}" and all its data?`)) {
                fetch(`/api/device/${deviceId}/sensor/${sensorId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => alert('Error deleting sensor: ' + error));
            }
        }
    </script>
</body>
</html>
